<!DOCTYPE html>
<html lang="zh-CN" class="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>月亮的导航页</title>
  <!-- 引入外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#10B981',
            dark: {
              bg: '#121212',
              card: '#1E1E1E',
              text: '#E0E0E0'
            },
            light: {
              bg: '#F8FAFC',
              card: '#FFFFFF',
              text: '#1E293B'
            }
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'float': 'float 3s ease-in-out infinite',
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            }
          }
        },
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .glass {
        backdrop-filter: blur(12px);
        background-color: rgba(255, 255, 255, 0.7);
      }
      .glass-dark {
        backdrop-filter: blur(12px);
        background-color: rgba(18, 18, 18, 0.7);
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
      .dragging {
        opacity: 0.5;
        transform: scale(1.05);
      }
      .context-menu {
        @apply fixed z-50 w-48 bg-light-card dark:bg-dark-card rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden;
      }
      .context-menu-item {
        @apply px-4 py-2 text-sm flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer transition-all-300;
      }
    }
  </style>
  
  <style>
    /* 基础样式 */
    body {
      font-family: 'Inter', system-ui, sans-serif;
      overflow-x: hidden;
    }
    
    /* 背景粒子效果 */
    .particle {
      position: absolute;
      border-radius: 50%;
      background: rgba(79, 70, 229, 0.1);
      animation: float 8s ease-in-out infinite;
      z-index: 0;
    }
    
    /* 平滑滚动 */
    html {
      scroll-behavior: smooth;
    }
    
    /* 自定义滚动条 */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(79, 70, 229, 0.3);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(79, 70, 229, 0.5);
    }
    
    /* 搜索框聚焦效果 */
    .search-input:focus {
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
    }
    
    /* 网站图标样式 */
    .site-icon {
      width: 24px;
      height: 24px;
      object-fit: contain;
    }
    
    /* 阻止默认右键菜单 */
    .shortcut-link {
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    
    /* 模态框动画 */
    .modal-enter {
      animation: modalEnter 0.3s ease-out forwards;
    }
    
    @keyframes modalEnter {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
  </style>
</head>

<body class="min-h-screen bg-light-bg text-light-text dark:bg-dark-bg dark:text-dark-text transition-all duration-300">
  <!-- 背景粒子 -->
  <div id="particles" class="fixed inset-0 -z-10 overflow-hidden"></div>
  
  <!-- 主容器 -->
  <div class="container mx-auto px-4 py-8 md:py-16 max-w-5xl">
    <!-- 头部区域 -->
    <header class="flex flex-col items-center justify-center mb-12">
      <!-- 主题切换按钮 -->
      <button id="theme-toggle" class="self-end p-2 rounded-full bg-light-card dark:bg-dark-card shadow-md hover:shadow-lg transition-all-300">
        <i class="fa fa-moon-o dark:hidden text-xl text-gray-600"></i>
        <i class="fa fa-sun-o hidden dark:block text-xl text-yellow-300"></i>
      </button>
      
      <!-- 日期时间显示 -->
      <div class="text-center mt-4 mb-8">
        <h1 id="date" class="text-2xl md:text-3xl font-bold text-light-text dark:text-white text-shadow"></h1>
        <p id="time" class="text-4xl md:text-6xl font-bold mt-2 text-light-text dark:text-white animate-pulse-slow"></p>
      </div>
      
      <!-- 搜索框 -->
      <div class="relative w-full max-w-xl">
        <input 
          type="text" 
          id="search-input" 
          class="search-input w-full px-5 py-3 pl-12 pr-12 rounded-full bg-light-card dark:bg-dark-card shadow-lg border border-gray-200 dark:border-gray-700 focus:outline-none focus:border-primary dark:focus:border-secondary transition-all-300"
          placeholder="搜索网页或输入网址..."
        >
        <i class="fa fa-search absolute left-5 top-1/2 -translate-y-1/2 text-gray-400"></i>
        <button id="search-button" class="absolute right-3 top-1/2 -translate-y-1/2 bg-primary dark:bg-secondary text-white px-4 py-1 rounded-full text-sm hover:bg-primary/90 dark:hover:bg-secondary/90 transition-all-300">
          搜索
        </button>
      </div>
    </header>
    
    <!-- 快捷导航区域 -->
    <section class="mt-8">
      <h2 class="text-lg md:text-xl font-bold mb-4 text-center">常用网站 <span class="text-xs font-normal text-gray-500 dark:text-gray-400">(右键可编辑/删除)</span></h2>
      
      <div id="shortcuts-container" class="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2 md:gap-3">
        <!-- 快捷方式将通过JS动态渲染 -->
        <button id="add-shortcut" class="flex flex-col items-center p-2 rounded-lg bg-light-card dark:bg-dark-card shadow-md hover:shadow-xl hover:-translate-y-1 transition-all-300 border-2 border-dashed border-gray-300 dark:border-gray-600">
          <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-1">
            <i class="fa fa-plus text-gray-400 text-sm"></i>
          </div>
          <span class="text-xs font-medium text-center text-gray-500 dark:text-gray-400">添加</span>
        </button>
      </div>
    </section>
    
    <!-- 底部区域 -->
    <footer class="mt-12 text-center text-gray-500 dark:text-gray-400 text-sm">
      <p>月亮的导航页 &copy; 2026</p>
      <p class="mt-2">点击右上角切换主题 | 可拖拽排序快捷方式 | 右键编辑/删除快捷方式</p>
    </footer>
  </div>
  
  <!-- 快捷方式模态框 -->
  <div id="shortcut-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-light-card dark:bg-dark-card rounded-2xl shadow-2xl p-6 w-full max-w-md mx-4 transform transition-all-300 scale-95 opacity-0" id="modal-content">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold" id="modal-title">添加快捷方式</h3>
        <button id="close-modal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fa fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="shortcut-form">
        <input type="hidden" id="edit-shortcut-id">
        
        <div class="mb-4">
          <label for="shortcut-name" class="block text-sm font-medium mb-1">网站名称</label>
          <input type="text" id="shortcut-name" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-light-bg dark:bg-dark-bg focus:outline-none focus:border-primary dark:focus:border-secondary" required>
        </div>
        
        <div class="mb-4">
          <label for="shortcut-url" class="block text-sm font-medium mb-1">网站地址</label>
          <input type="url" id="shortcut-url" class="w-full px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-light-bg dark:bg-dark-bg focus:outline-none focus:border-primary dark:focus:border-secondary" required>
        </div>
        
        <div class="mb-6">
          <label class="block text-sm font-medium mb-1">网站图标（自动获取）</label>
          <div class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-800 mb-2" id="preview-icon">
            <i class="fa fa-globe text-gray-400"></i>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400">将自动从网站获取图标</p>
        </div>
        
        <div class="flex gap-3">
          <button type="button" id="cancel-shortcut" class="flex-1 px-4 py-2 rounded-lg border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-all-300">
            取消
          </button>
          <button type="submit" class="flex-1 px-4 py-2 rounded-lg bg-primary dark:bg-secondary text-white hover:bg-primary/90 dark:hover:bg-secondary/90 transition-all-300" id="form-submit-btn">
            添加
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- 右键菜单 -->
  <div id="context-menu" class="context-menu hidden">
    <div class="context-menu-item" id="ctx-edit">
      <i class="fa fa-pencil text-primary dark:text-secondary"></i>
      <span>编辑</span>
    </div>
    <div class="context-menu-item" id="ctx-delete">
      <i class="fa fa-trash text-red-500"></i>
      <span>删除</span>
    </div>
  </div>

  <script>
    // 常量定义 - 集中管理DOM元素和配置
    const DOM = {
      date: document.getElementById('date'),
      time: document.getElementById('time'),
      themeToggle: document.getElementById('theme-toggle'),
      searchInput: document.getElementById('search-input'),
      searchButton: document.getElementById('search-button'),
      particles: document.getElementById('particles'),
      shortcutsContainer: document.getElementById('shortcuts-container'),
      addShortcutBtn: document.getElementById('add-shortcut'),
      shortcutModal: document.getElementById('shortcut-modal'),
      modalContent: document.getElementById('modal-content'),
      closeModalBtn: document.getElementById('close-modal'),
      cancelShortcutBtn: document.getElementById('cancel-shortcut'),
      shortcutForm: document.getElementById('shortcut-form'),
      shortcutName: document.getElementById('shortcut-name'),
      shortcutUrl: document.getElementById('shortcut-url'),
      previewIcon: document.getElementById('preview-icon'),
      modalTitle: document.getElementById('modal-title'),
      formSubmitBtn: document.getElementById('form-submit-btn'),
      editShortcutId: document.getElementById('edit-shortcut-id'),
      contextMenu: document.getElementById('context-menu'),
      ctxEdit: document.getElementById('ctx-edit'),
      ctxDelete: document.getElementById('ctx-delete')
    };

    const CONFIG = {
      particleCount: 20,
      defaultShortcuts: [
        { id: 'baidu', name: '百度', url: 'https://www.baidu.com', icon: 'https://www.baidu.com/favicon.ico' },
        { id: 'bilibili', name: '哔哩哔哩', url: 'https://www.bilibili.com', icon: 'https://www.bilibili.com/favicon.ico' },
        { id: 'zhihu', name: '知乎', url: 'https://www.zhihu.com', icon: 'https://www.zhihu.com/favicon.ico' },
        { id: 'taobao', name: '淘宝', url: 'https://www.taobao.com', icon: 'https://www.taobao.com/favicon.ico' },
        { id: 'jd', name: '京东', url: 'https://www.jd.com', icon: 'https://www.jd.com/favicon.ico' }
      ],
      storageKey: 'customNavShortcuts'
    };

    // 全局状态管理
    const state = {
      currentShortcut: null,
      isDarkMode: false
    };

    // 工具函数 - 通用功能封装
    const utils = {
      // 生成唯一ID
      generateId() {
        return `shortcut_${Date.now()}_${Math.floor(Math.random() * 1000)}`;
      },

      // 格式化URL
      formatUrl(url) {
        if (!url) return '';
        return url.startsWith('http') ? url : `https://${url}`;
      },

      // 获取网站图标URL
      getFaviconUrl(url) {
        try {
          const urlObj = new URL(this.formatUrl(url));
          return `${urlObj.protocol}//${urlObj.hostname}/favicon.ico`;
        } catch (e) {
          return '';
        }
      },

      // 本地存储操作
      storage: {
        get() {
          const data = localStorage.getItem(CONFIG.storageKey);
          return data ? JSON.parse(data) : CONFIG.defaultShortcuts;
        },
        set(data) {
          localStorage.setItem(CONFIG.storageKey, JSON.stringify(data));
        },
        clear() {
          localStorage.removeItem(CONFIG.storageKey);
        }
      },

      // 检查是否为有效URL
      isValidUrl(url) {
        try {
          new URL(this.formatUrl(url));
          return true;
        } catch (e) {
          return false;
        }
      }
    };

    // 日期时间模块
    const dateTimeModule = {
      init() {
        this.update();
        setInterval(() => this.update(), 1000);
      },

      update() {
        const now = new Date();
        this.updateDate(now);
        this.updateTime(now);
      },

      updateDate(date) {
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        DOM.date.textContent = date.toLocaleDateString('zh-CN', options);
      },

      updateTime(date) {
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        DOM.time.textContent = `${hours}:${minutes}:${seconds}`;
      }
    };

    // 主题切换模块
    const themeModule = {
      init() {
        // 初始化主题状态
        state.isDarkMode = localStorage.getItem('theme') === 'dark' || 
                          (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);
        
        this.applyTheme();
        this.bindEvents();
      },

      applyTheme() {
        if (state.isDarkMode) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        }
      },

      toggleTheme() {
        state.isDarkMode = !state.isDarkMode;
        this.applyTheme();
      },

      bindEvents() {
        DOM.themeToggle.addEventListener('click', () => this.toggleTheme());
      }
    };

    // 搜索模块
    const searchModule = {
      init() {
        this.bindEvents();
      },

      performSearch(query) {
        if (!query.trim()) return;

        if (utils.isValidUrl(query)) {
          window.open(utils.formatUrl(query), '_blank');
        } else {
          const searchUrl = `https://www.baidu.com/s?wd=${encodeURIComponent(query)}`;
          window.open(searchUrl, '_blank');
        }

        DOM.searchInput.value = '';
      },

      bindEvents() {
        DOM.searchButton.addEventListener('click', () => {
          this.performSearch(DOM.searchInput.value);
        });

        DOM.searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            this.performSearch(DOM.searchInput.value);
          }
        });
      }
    };

    // 背景粒子模块
    const particlesModule = {
      init() {
        this.createParticles();
      },

      createParticles() {
        for (let i = 0; i < CONFIG.particleCount; i++) {
          const particle = document.createElement('div');
          particle.classList.add('particle');
          
          // 随机配置
          const size = Math.random() * 150 + 50;
          particle.style.width = particle.style.height = `${size}px`;
          particle.style.left = `${Math.random() * 100}%`;
          particle.style.top = `${Math.random() * 100}%`;
          particle.style.opacity = Math.random() * 0.3 + 0.1;
          particle.style.animationDelay = `${Math.random() * 5}s`;
          particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
          
          DOM.particles.appendChild(particle);
        }
      }
    };

    // 快捷方式模块 - 核心功能
    const shortcutModule = {
      init() {
        this.renderShortcuts();
        this.initDragAndDrop();
        this.bindEvents();
      },

      // 渲染所有快捷方式
      renderShortcuts() {
        const shortcuts = utils.storage.get();
        const addBtn = DOM.addShortcutBtn;
        
        // 清空现有快捷方式（保留添加按钮）
        this.clearShortcuts();
        
        // 渲染每个快捷方式
        shortcuts.forEach(shortcut => {
          const shortcutElement = this.createShortcutElement(shortcut);
          DOM.shortcutsContainer.insertBefore(shortcutElement, addBtn);
          this.bindContextMenu(shortcutElement);
        });
      },

      // 清空快捷方式
      clearShortcuts() {
        const shortcuts = DOM.shortcutsContainer.querySelectorAll('.shortcut-link');
        shortcuts.forEach(shortcut => shortcut.remove());
      },

      // 创建单个快捷方式元素
      createShortcutElement(shortcutData) {
        const { id, name, url, icon } = shortcutData;
        
        const shortcut = document.createElement('a');
        shortcut.href = url;
        shortcut.target = '_blank';
        shortcut.className = 'shortcut-link';
        shortcut.draggable = true;
        shortcut.dataset.id = id;
        
        // 图标HTML
        let iconHtml = '';
        if (icon && utils.isValidUrl(icon)) {
          iconHtml = `<img src="${icon}" alt="${name}" class="site-icon" onerror="this.parentElement.innerHTML='<i class=\'fa fa-globe text-gray-500 text-sm\'></i>'">`;
        } else {
          const faviconUrl = utils.getFaviconUrl(url);
          iconHtml = `<img src="${faviconUrl}" alt="${name}" class="site-icon" onerror="this.parentElement.innerHTML='<i class=\'fa fa-globe text-gray-500 text-sm\'></i>'">`;
        }
        
        shortcut.innerHTML = `
          <div class="flex flex-col items-center p-2 rounded-lg bg-light-card dark:bg-dark-card shadow-md hover:shadow-xl hover:-translate-y-1 transition-all-300">
            <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center mb-1 p-1">
              ${iconHtml}
            </div>
            <span class="text-xs font-medium text-center">${name}</span>
          </div>
        `;
        
        return shortcut;
      },

      // 添加快捷方式
      addShortcut(shortcutData) {
        const shortcuts = utils.storage.get();
        const newShortcut = {
          id: utils.generateId(),
          name: shortcutData.name,
          url: utils.formatUrl(shortcutData.url),
          icon: utils.getFaviconUrl(shortcutData.url)
        };
        
        // 保存到本地存储
        shortcuts.push(newShortcut);
        utils.storage.set(shortcuts);
        
        // 渲染到页面
        const addBtn = DOM.addShortcutBtn;
        const shortcutElement = this.createShortcutElement(newShortcut);
        DOM.shortcutsContainer.insertBefore(shortcutElement, addBtn);
        this.bindContextMenu(shortcutElement);
        
        // 添加动画效果
        this.addAnimation(shortcutElement);
        
        // 重新初始化拖拽
        this.initDragAndDrop();
        
        return newShortcut;
      },

      // 编辑快捷方式
      editShortcut(shortcutId, updatedData) {
        const shortcuts = utils.storage.get();
        const index = shortcuts.findIndex(s => s.id === shortcutId);
        
        if (index !== -1) {
          // 更新数据
          shortcuts[index] = {
            ...shortcuts[index],
            name: updatedData.name,
            url: utils.formatUrl(updatedData.url),
            icon: utils.getFaviconUrl(updatedData.url)
          };
          
          // 保存到本地存储
          utils.storage.set(shortcuts);
          
          // 更新DOM
          const shortcutElement = document.querySelector(`.shortcut-link[data-id="${shortcutId}"]`);
          if (shortcutElement) {
            const newElement = this.createShortcutElement(shortcuts[index]);
            shortcutElement.replaceWith(newElement);
            this.bindContextMenu(newElement);
            this.addAnimation(newElement);
          }
          
          return shortcuts[index];
        }
        
        return null;
      },

      // 删除快捷方式
      deleteShortcut(shortcutId) {
        if (!confirm('确定要删除这个快捷方式吗？')) return false;
        
        const shortcuts = utils.storage.get();
        const newShortcuts = shortcuts.filter(s => s.id !== shortcutId);
        
        // 保存到本地存储
        utils.storage.set(newShortcuts);
        
        // 从DOM中移除
        const shortcutElement = document.querySelector(`.shortcut-link[data-id="${shortcutId}"]`);
        if (shortcutElement) {
          // 添加删除动画
          const shortcutDiv = shortcutElement.querySelector('div');
          shortcutDiv.style.opacity = '0';
          shortcutDiv.style.transform = 'scale(0.8)';
          
          setTimeout(() => {
            shortcutElement.remove();
            this.initDragAndDrop();
          }, 300);
        }
        
        return true;
      },

      // 添加动画效果
      addAnimation(element) {
        const shortcutDiv = element.querySelector('div');
        shortcutDiv.classList.add('animate-float');
        setTimeout(() => {
          shortcutDiv.classList.remove('animate-float');
        }, 1500);
      },

      // 初始化拖拽排序
      initDragAndDrop() {
        const container = DOM.shortcutsContainer;
        const addBtn = DOM.addShortcutBtn;
        
        // 销毁现有实例
        if (this.sortableInstance) {
          this.sortableInstance.destroy();
        }
        
        // 创建新实例
        this.sortableInstance = new Sortable(container, {
          animation: 150,
          handle: '.shortcut-link',
          draggable: '.shortcut-link',
          ghostClass: 'dragging',
          onEnd: () => {
            // 确保添加按钮始终在最后
            container.appendChild(addBtn);
            // 保存新排序
            this.saveOrder();
          }
        });
      },

      // 保存排序
      saveOrder() {
        const shortcuts = [];
        const shortcutElements = DOM.shortcutsContainer.querySelectorAll('.shortcut-link');
        
        shortcutElements.forEach(element => {
          const id = element.dataset.id;
          const savedShortcuts = utils.storage.get();
          const shortcut = savedShortcuts.find(s => s.id === id);
          
          if (shortcut) {
            shortcuts.push(shortcut);
          }
        });
        
        utils.storage.set(shortcuts);
      },

      // 绑定右键菜单
      bindContextMenu(shortcutElement) {
        shortcutElement.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // 保存当前选中的快捷方式
          state.currentShortcut = shortcutElement;
          
          // 显示右键菜单
          this.showContextMenu(e.clientX, e.clientY);
        });
      },

      // 显示右键菜单
      showContextMenu(x, y) {
        const menu = DOM.contextMenu;
        const menuWidth = menu.offsetWidth;
        const menuHeight = menu.offsetHeight;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        
        // 计算菜单位置，避免超出视口
        let menuX = x;
        let menuY = y;
        
        if (x + menuWidth > windowWidth) {
          menuX = windowWidth - menuWidth - 10;
        }
        
        if (y + menuHeight > windowHeight) {
          menuY = windowHeight - menuHeight - 10;
        }
        
        menu.style.left = `${menuX}px`;
        menu.style.top = `${menuY}px`;
        menu.classList.remove('hidden');
        
        // 点击其他区域关闭菜单
        this.bindContextMenuCloseEvents();
      },

      // 绑定关闭右键菜单的事件
      bindContextMenuCloseEvents() {
        const closeHandler = () => {
          DOM.contextMenu.classList.add('hidden');
          document.removeEventListener('click', closeHandler);
          document.removeEventListener('contextmenu', closeHandler);
        };
        
        document.addEventListener('click', closeHandler);
        document.addEventListener('contextmenu', closeHandler);
      },

      // 绑定事件
      bindEvents() {
        // 添加快捷方式按钮
        DOM.addShortcutBtn.addEventListener('click', () => {
          modalModule.open('add');
        });
        
        // 编辑菜单项
        DOM.ctxEdit.addEventListener('click', () => {
          if (state.currentShortcut) {
            const id = state.currentShortcut.dataset.id;
            const shortcuts = utils.storage.get();
            const shortcut = shortcuts.find(s => s.id === id);
            
            if (shortcut) {
              modalModule.open('edit', shortcut);
            }
          }
          DOM.contextMenu.classList.add('hidden');
        });
        
        // 删除菜单项
        DOM.ctxDelete.addEventListener('click', () => {
          if (state.currentShortcut) {
            this.deleteShortcut(state.currentShortcut.dataset.id);
          }
          DOM.contextMenu.classList.add('hidden');
        });
      }
    };

    // 模态框模块
    const modalModule = {
      init() {
        this.bindEvents();
        this.bindUrlPreview();
      },

      // 打开模态框
      open(mode = 'add', shortcutData = null) {
        DOM.shortcutModal.classList.remove('hidden');
        
        if (mode === 'add') {
          // 添加模式
          DOM.modalTitle.textContent = '添加快捷方式';
          DOM.formSubmitBtn.textContent = '添加';
          DOM.editShortcutId.value = '';
          DOM.shortcutForm.reset();
          this.updatePreviewIcon('');
        } else if (mode === 'edit' && shortcutData) {
          // 编辑模式
          DOM.modalTitle.textContent = '编辑快捷方式';
          DOM.formSubmitBtn.textContent = '保存修改';
          DOM.editShortcutId.value = shortcutData.id;
          DOM.shortcutName.value = shortcutData.name;
          DOM.shortcutUrl.value = shortcutData.url;
          this.updatePreviewIcon(shortcutData.icon || shortcutData.url);
        }
        
        // 显示动画
        setTimeout(() => {
          DOM.modalContent.classList.remove('scale-95', 'opacity-0');
          DOM.modalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
      },

      // 关闭模态框
      close() {
        DOM.modalContent.classList.remove('scale-100', 'opacity-100');
        DOM.modalContent.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
          DOM.shortcutModal.classList.add('hidden');
          DOM.shortcutForm.reset();
        }, 300);
      },

      // 更新预览图标
      updatePreviewIcon(url) {
        if (!url) {
          DOM.previewIcon.innerHTML = '<i class="fa fa-globe text-gray-400"></i>';
          return;
        }
        
        const faviconUrl = utils.isValidUrl(url) ? url : utils.getFaviconUrl(url);
        
        // 测试图标是否存在
        const testImg = new Image();
        testImg.src = faviconUrl;
        testImg.onload = () => {
          DOM.previewIcon.innerHTML = `<img src="${faviconUrl}" alt="预览" class="site-icon">`;
        };
        testImg.onerror = () => {
          DOM.previewIcon.innerHTML = '<i class="fa fa-globe text-gray-400"></i>';
        };
      },

      // 绑定URL输入预览
      bindUrlPreview() {
        DOM.shortcutUrl.addEventListener('input', (e) => {
          this.updatePreviewIcon(e.target.value);
        });
      },

      // 绑定事件
      bindEvents() {
        // 关闭模态框
        DOM.closeModalBtn.addEventListener('click', () => this.close());
        DOM.cancelShortcutBtn.addEventListener('click', () => this.close());
        
        // 点击背景关闭
        DOM.shortcutModal.addEventListener('click', (e) => {
          if (e.target === DOM.shortcutModal) {
            this.close();
          }
        });
        
        // 表单提交
        DOM.shortcutForm.addEventListener('submit', (e) => {
          e.preventDefault();
          
          const name = DOM.shortcutName.value.trim();
          const url = DOM.shortcutUrl.value.trim();
          const editId = DOM.editShortcutId.value;
          
          if (!name || !url) return;
          
          if (editId) {
            // 编辑模式
            shortcutModule.editShortcut(editId, { name, url });
          } else {
            // 添加模式
            shortcutModule.addShortcut({ name, url });
          }
          
          this.close();
        });
      }
    };

    // 初始化应用
    const app = {
      init() {
        // 按顺序初始化各个模块
        dateTimeModule.init();
        themeModule.init();
        searchModule.init();
        particlesModule.init();
        modalModule.init();
        shortcutModule.init();
      }
    };

    // 页面加载完成后初始化
    window.addEventListener('load', () => {
      app.init();
    });
  </script>
</body>
</html>
